generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(cuid())
  email                  String             @unique
  password               String
  walletAddress          String?
  stakeAmount            Decimal?           @db.Decimal(10, 2)
  stakeTransactionHash   String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  points                 Int                @default(0)
  accuracy30DayStart     DateTime?
  consecutiveCorrectDays Int                @default(0)
  correctVotes           Int                @default(0)
  godModeBadge           Boolean            @default(false)
  godModeBadgeEarnedAt   DateTime?
  isBanned               Boolean            @default(false)
  rankUpdatedAt          DateTime?
  totalVotes             Int                @default(0)
  rank                   String?            @map("user_rank")
  agents                 Agent[]
  notifications          Notification[]
  votes                  Vote[]
  voteAccuracies         VoteAccuracy[]
  voterEligibilities     VoterEligibility[]
}

model Task {
  id                 String             @id @default(cuid())
  text               String
  taskType           String
  paymentSignature   String?
  status             String             @default("pending")
  result             Json?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  agentName          String?
  category           String?
  context            Json?
  escrowAmount       String?
  reward             String?
  rewardAmount       Decimal?           @db.Decimal(10, 2)
  aiCertainty        Decimal?           @db.Decimal(3, 2)
  consensusThreshold Decimal?           @db.Decimal(3, 2)
  currentVoteCount   Int                @default(0)
  noVotes            Int                @default(0)
  requiredVoters     Int?               @default(3)
  yesVotes           Int                @default(0)
  currentPhase       Int                @default(1)
  phaseMeta          Json?
  taskTier           String?
  agentSessionId     String?
  phaseTransitions   PhaseTransition[]
  agentSession       AgentSession?      @relation(fields: [agentSessionId], references: [id], onDelete: Cascade)
  votes              Vote[]
  voteAccuracies     VoteAccuracy[]
  voterEligibilities VoterEligibility[]

  @@index([agentSessionId])
  @@index([currentPhase])
}

model Vote {
  id        String   @id @default(cuid())
  taskId    String
  userId    String?
  decision  String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  metadata  Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model VoteAccuracy {
  id                String   @id @default(cuid())
  userId            String
  taskId            String
  voteDecision      String
  consensusDecision String
  isCorrect         Boolean
  createdAt         DateTime @default(now())
  task              Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([taskId])
}

model Agent {
  id                  String             @id @default(cuid())
  userId              String
  name                String
  description         String?
  avatarUrl           String?
  confidenceThreshold Decimal            @db.Decimal(3, 2)
  maxDailyBudget      Decimal            @db.Decimal(10, 2)
  responseTime        String
  agentId             String             @unique
  apiKeyHash          String
  balance             Decimal            @default(0) @db.Decimal(10, 2)
  walletAddress       String?
  onChainAddress      String?
  isActive            Boolean            @default(true)
  autoRefuelEnabled   Boolean            @default(false)
  autoRefuelThreshold Decimal?           @db.Decimal(10, 2)
  autoRefuelAmount    Decimal?           @db.Decimal(10, 2)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities          AgentActivity[]
  transactions        AgentTransaction[]

  @@index([userId])
  @@index([agentId])
}

model AgentActivity {
  id           String   @id @default(cuid())
  agentId      String
  taskId       String?
  query        String
  aiConfidence Decimal? @db.Decimal(3, 2)
  status       String
  humanVerdict String?
  cost         Decimal? @db.Decimal(10, 2)
  timestamp    DateTime @default(now())
  agent        Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId, timestamp])
  @@index([taskId])
}

model AgentTransaction {
  id        String   @id @default(cuid())
  agentId   String
  type      String
  amount    Decimal  @db.Decimal(10, 2)
  signature String?
  metadata  Json?
  createdAt DateTime @default(now())
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId, createdAt])
}

model AgentSession {
  id            String    @id @default(cuid())
  agentName     String
  walletAddress String
  status        String    @default("active")
  lastHeartbeat DateTime  @default(now())
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tasks         Task[]

  @@index([agentName, status])
  @@index([walletAddress, status])
  @@index([lastHeartbeat])
}

model PhaseTransition {
  id         String   @id @default(cuid())
  taskId     String
  fromPhase  Int
  toPhase    Int?
  reason     String
  voterCount Int
  timestamp  DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([timestamp])
}

model VoterEligibility {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  phase     Int
  eligible  Boolean
  reason    String?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId, phase])
  @@index([taskId, phase])
  @@index([userId, phase])
}
